# A Five-Stage-Pipeline CPU

## 写在前面

​	本次课程设计我完成的是一个基于mips32的具有五级流水的，包含了21条指令的指令集的cpu，实现了mips32三种基本类型的指令，解决了在流水过程中的数据相关和控制相关，并且对每条指令进行一个仿真测试，可以完成一些基本程序的运行，并将cpu综合到开发板上面，通过led灯将指令流水展示出来，最后写了一个函数来对cpu进行一个上板测试。

​	该课程设计涉及的相关课程很多，主要的有丁贤庆老师的数字逻辑课程，阙夏老师的计算机组成原理课程，李建华老师的计算机体系结构课程，张本宏老师的汇编语言课程，需要自己学习的知识有Verilog硬件语言和FPGA实验板的相关知识。

​	整个的设计过程全部由我一个人独立完成，之所以选择一个人来完成是因为这样可以让我思路逻辑更加清晰，并且可以对cpu有一个更全面的认识，对我未来发展有很大帮助。

> 设计要求: 基于先修课程，根据系统设计思想，使用硬件描述语言设计实现一款基于MIPS32，ARM，RISC-V或者自定义指令集的微处理器（CPU）。
>
> **要求：**完成单周期CPU设计，或多周期CPU设计，或5级流水线CPU设计（递进式、难度依次提升。所有学生必须至少完成单周期CPU的设计工作），并将设计的CPU下载至FPGA开发板（ego-1）上运行。以此贯穿数字逻辑、计算机组成原理、计算机体系结构课程，实现从逻辑门至完整CPU处理器的设计



## 设计思路

### 数据流通路

​	本次课程设计完成的cpu总共有十二个部分，分别包括了PC寄存器、id译码模块、ex执行模块、mem访存模块、寄存器堆、流水线暂停模块、指令存储器和数据存储器，以及四个流水线寄存器共同组成，在后面将一一对每个模块进行介绍。

​	实验过程中参考了雷思磊的《自己动手写cpu》，这本书对我刚开始独立完成cpu框架的搭建极为重要，为我打开了设计cpu的大门，完成了基于openmips的cpu的设计，本次课设所实现的cpu数据通路如下：

![image-20230830194941881](README.assets/image-20230830194941881.png)



<center>图 1  cpu数据通路图</center>

以此构成了五级流水线的mips32cpu，各个阶段完成的主要工作如下：

1. **取指:**取出指令存储器中的指令，PC值递增，准备取下一条指令。

2. **译码:**对指令进行译码，依据译码结果，从32个通用寄存器中取出源操作数，有的指令要求两个源操作数都是寄存器的值，比如or指令，有的指令要求其中一个源操作数是指令中立即数的扩展，比如 ori指令，所以这里有两个复用器，用于依据指令要求，确定参与运算的操作数，最终确定的两个操作数会送到执行阶段。

3. **执行**阶段:依据译码阶段送入的源操作数、操作码，进行运算，对于ori指令而言，就是进行逻辑“或”运算，运算结果传递到访存阶段。

4. **访存**阶段:对于ori指令，在访存阶段没有任何操作，直接将运算结果向下传递到回写阶段。

5. **回写**阶段:将运算结果保存到目的寄存器。

对cpu进行封装，封装后的cpu效果如下：

![image-20230830195205777](README.assets/image-20230830195205777.png)

<center>图 2 封装效果图1</center>

![image-20230830195218874](README.assets/image-20230830195218874.png)

<center>图 3封装效果图2</center>

### 模块介绍

此处简要介绍一下设计的模块, 具体内容详见项目报告.

#### 基本核心模块

1. **PC寄存器**

   PC的作用是给出指令地址，其接口如下：

   <img src="README.assets/image-20230830195326871.png" alt="image-20230830195326871" style="zoom:67%;" />

   <center>图 4 PC寄存器</center>

2. **id模块（译码）**

   ID模块的作用是对指令进行译码，得到最终运算的类型、子类型、源操作数1、源操作数2、要写入的目的寄存器地址等信息，其中运算类型指的是逻辑运算、移位运算、算术运算等，子类型指的是更加详细的运算类型。

   <img src="README.assets/image-20230830195528533.png" alt="image-20230830195528533" style="zoom:67%;" />

<center>图 5 id模块</center>




3. **ex模块（执行）**

   EX模块会从ID/EX模块得到运算类型alusel_i、运算子类型aluop_i、源操作数regl_i、源操作数reg2_i、要写的目的寄存器地址 wd_i，EX模块会依据这些数据进行运算。

<img src="README.assets/image-20230830195707426.png" alt="image-20230830195707426" style="zoom:67%;" />

<center>图 6 ex模块



#### 流水线寄存器



#### 其他相关模块



#### 顶层封装模块



## 设计指令

### R类指令



### I类指令



### J类指令





## 流水线相关的处理

### 数据相关



### 控制相关





## 实验结果分享

### 仿真结果分享





## 总结

### 小问题



### 心得体会



## 参考文献
